<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K3 Drink Scanner</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        #app {
            text-align: center;
            background-color: #2a2a2a;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 90%;
        }
        h1 {
            font-size: 3em;
            margin-bottom: 10px;
            color: #ff6b6b;
        }
        h2 {
            font-family: 'Creepster', cursive;
            font-size: 2em;
            margin-top: 0;
            margin-bottom: 30px;
            color: #4ecdc4;
        }
        #status {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #f7fff7;
        }
        #result {
            font-size: 1.5em;
            margin-top: 30px;
            padding: 20px;
            background-color: #4ecdc4;
            color: #1a1a1a;
            border-radius: 10px;
            display: none;
        }
        .drink-list {
            text-align: left;
            margin: 20px auto;
            max-width: 400px;
        }
        .drink-list li {
            margin-bottom: 10px;
        }
        .success-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ff6b6b;
            color: white;
            padding: 30px;
            border-radius: 15px;
            z-index: 1000;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            animation: popIn 0.5s ease-out;
        }
        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>Welcome to K3!</h1>
        <h2>Work | Sin | Party</h2>
        <p id="status">To buy a drink, please scan your tag.</p>
        <p>Every drink is €2:</p>
        <ul class="drink-list">
            <li>Beer: 1 pint</li>
            <li>Tinto de Verano (Red wine + lemonade): 1/2 pint</li>
            <li>White wine spritz: 1/2 pint</li>
            <li>Radler (Beer + lemonade): 1 pint</li>
            <li>Hop soda (non-alc): 1 pint</li>
            <li>Club mate (non-alc + caffeinated): 1 pint</li>
        </ul>
        <div id="result"></div>
    </div>

    <script>
        const statusElement = document.getElementById('status');
        const resultElement = document.getElementById('result');
        let ndef;

        const DRINKS_API_URL = 'https://sheetdb.io/api/v1/51yvtuyojo7nh';
        const REGISTRATION_API_URL = 'https://sheetdb.io/api/v1/lbl3bv5dm0ein';

        const scanSound = new Audio('scan_sound.mp3');
        const uploadSound = new Audio('upload_sound.mp3');

        function updateStatus(message) {
            statusElement.textContent = message;
        }

        function showSuccess(message) {
            const successPopup = document.createElement('div');
            successPopup.className = 'success-popup';
            successPopup.textContent = message;
            document.body.appendChild(successPopup);
            setTimeout(() => successPopup.remove(), 5000);
        }

        function showError(message) {
            showSuccess(message); // Using the same style for errors
        }

        async function getNameFromUid(uid) {
            try {
                const response = await fetch(REGISTRATION_API_URL);
                if (!response.ok) {
                    throw new Error("Error fetching registration data from SheetsDB");
                }
                const registrationData = await response.json();
                const entry = registrationData.find(entry => entry.uid === uid);
                return entry ? entry.name : null;
            } catch (error) {
                showError(`Error: ${error.message}`);
                return null;
            }
        }

        async function incrementOrAddUid(uid) {
            try {
                const response = await fetch(DRINKS_API_URL);
                if (!response.ok) {
                    throw new Error("Error fetching data from SheetsDB");
                }
                const data = await response.json();

                const existingEntry = data.find(entry => entry.uid === uid);

                if (existingEntry) {
                    const newCount = parseInt(existingEntry.num_drinks) + 1;
                    const updateResponse = await fetch(`${DRINKS_API_URL}/uid/${uid}`, {
                        method: 'PATCH',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ data: { num_drinks: newCount } })
                    });

                    if (updateResponse.ok) {
                        const name = await getNameFromUid(uid);
                        if (name) {
                            showSuccess(`Cheers, ${name}! 🍻\nYou've just bought your ${newCount}${getOrdinalSuffix(newCount)} drink!`);
                        } else {
                            showSuccess(`Cheers! 🍻\nYou've just bought your ${newCount}${getOrdinalSuffix(newCount)} drink!`);
                        }
                        return newCount;
                    } else {
                        throw new Error(`Error updating UID ${uid}`);
                    }
                } else {
                    const newEntry = { uid: uid, num_drinks: 1 };
                    const addResponse = await fetch(DRINKS_API_URL, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ data: newEntry })
                    });

                    if (addResponse.ok) {
                        const name = await getNameFromUid(uid);
                        if (name) {
                            showSuccess(`Welcome, ${name}! 🎉\nYou've just bought your first drink!`);
                        } else {
                            showSuccess(`Welcome! 🎉\nYou've just bought your first drink!`);
                        }
                        return 1;
                    } else {
                        throw new Error(`Error adding UID ${uid}`);
                    }
                }
            } catch (error) {
                showError(`Error: ${error.message}`);
                return null;
            }
        }

        function getOrdinalSuffix(number) {
            const j = number % 10,
                  k = number % 100;
            if (j == 1 && k != 11) {
                return "st";
            }
            if (j == 2 && k != 12) {
                return "nd";
            }
            if (j == 3 && k != 13) {
                return "rd";
            }
            return "th";
        }

        async function handleNfcReading(uid) {
            try {
                await scanSound.play();
            } catch (error) {
                showError(`Error playing scan sound: ${error.message}`);
            }

            const totalDrinks = await incrementOrAddUid(uid);
            if (totalDrinks !== null) {
                try {
                    await uploadSound.play();
                } catch (error) {
                    showError(`Error playing upload sound: ${error.message}`);
                }
            }
        }

        async function startReading() {
            if ('NDEFReader' in window) {
                try {
                    ndef = new NDEFReader();
                    updateStatus('Ready to scan! Place your tag near the device.');
                    
                    await ndef.scan();
                    
                    ndef.addEventListener("reading", ({ serialNumber }) => {
                        handleNfcReading(serialNumber);
                    });

                } catch (error) {
                    showError(`Error starting NFC: ${error.message}`);
                    updateStatus(`Error: ${error.message}`);
                }
            } else {
                showError('NFC not supported on this device');
                updateStatus('NFC not supported');
            }
        }

        // Start reading NFC tags automatically when the page loads
        window.addEventListener('load', startReading);

        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => console.log('ServiceWorker registration successful with scope: ', registration.scope))
                .catch(err => showError(`ServiceWorker registration failed: ${err.message}`));
        }
    </script>
</body>
</html>