<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K3 Drink Scanner</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            color: #333333;
        }
        #app {
            text-align: center;
            background-color: #ffffff;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 90%;
        }
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #333333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        h2 {
            font-size: 1.5em;
            margin-top: 0;
            margin-bottom: 30px;
            color: #4ecdc4;
        }
        #status {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #333333;
        }
        #result {
            font-size: 1.5em;
            margin-top: 30px;
            padding: 20px;
            background-color: #4ecdc4;
            color: #ffffff;
            border-radius: 10px;
            display: none;
        }
        .drink-table {
            margin: 20px auto;
            border-collapse: collapse;
            width: 100%;
            max-width: 600px;
        }
        .drink-table th, .drink-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #4ecdc4;
        }
        .drink-table th:last-child, .drink-table td:last-child {
            text-align: right;
        }
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ff6b6b;
            color: white;
            padding: 30px;
            border-radius: 15px;
            z-index: 1000;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            animation: popIn 0.5s ease-out;
            text-align: center;
        }
        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>Welcome to K3!</h1>
        <h2>Work | Sin | Party</h2>
        <p id="status">Ready to scan! Place your tag on the back of the phone to buy a drink.</p>
        <p>Every drink is Â£2:</p>
        <table class="drink-table">
            <tr>
                <th>Drink</th>
                <th>Volume</th>
                <th>Price</th>
            </tr>
            <tr>
                <td>Beer</td>
                <td>1 pint</td>
                <td>Â£2</td>
            </tr>
            <tr>
                <td>Tinto de Verano<br><small>(Red wine + lemonade)</small></td>
                <td>1/2 pint</td>
                <td>Â£2</td>
            </tr>
            <tr>
                <td>White wine spritz</td>
                <td>1/2 pint</td>
                <td>Â£2</td>
            </tr>
            <tr>
                <td>Radler<br><small>(Beer + lemonade)</small></td>
                <td>1 pint</td>
                <td>Â£2</td>
            </tr>
            <tr>
                <td>Hop soda<br><small>(non-alc)</small></td>
                <td>1 pint</td>
                <td>Â£2</td>
            </tr>
            <tr>
                <td>Club mate<br><small>(non-alc + caffeinated)</small></td>
                <td>1 pint</td>
                <td>Â£2</td>
            </tr>
        </table>
        <div id="result"></div>
    </div>

    <script>
        const statusElement = document.getElementById('status');
        const resultElement = document.getElementById('result');
        let ndef;

        const DRINKS_API_URL = 'https://sheetdb.io/api/v1/51yvtuyojo7nh';
        const REGISTRATION_API_URL = 'https://sheetdb.io/api/v1/lbl3bv5dm0ein';
        const DRINK_COST = 2; // Cost per drink in GBP

        const scanSound = new Audio('scan_sound.mp3');
        const uploadSound = new Audio('upload_sound.mp3');

        function updateStatus(message) {
            statusElement.textContent = message;
        }

        function showPopup(message, type = 'success') {
            const popup = document.createElement('div');
            popup.className = `popup ${type}`;
            popup.textContent = message;
            document.body.appendChild(popup);
            setTimeout(() => removePopup(popup), 3000); // Remove popup after 3 seconds
            return popup;
        }

        function removePopup(popup) {
            popup.remove();
        }

        async function getNameFromUid(uid) {
            try {
                const response = await fetch(REGISTRATION_API_URL);
                if (!response.ok) {
                    throw new Error("Error fetching registration data from SheetsDB");
                }
                const registrationData = await response.json();
                const entry = registrationData.find(entry => entry.uid === uid);
                return entry ? entry.name : null;
            } catch (error) {
                showPopup(`Error: ${error.message}`, 'error');
                return null;
            }
        }

        async function incrementOrAddUid(uid) {
            try {
                const response = await fetch(DRINKS_API_URL);
                if (!response.ok) {
                    throw new Error("Error fetching data from SheetsDB");
                }
                const data = await response.json();

                const existingEntry = data.find(entry => entry.uid === uid);

                if (existingEntry) {
                    const newCount = parseInt(existingEntry.num_drinks) + 1;
                    const updateResponse = await fetch(`${DRINKS_API_URL}/uid/${uid}`, {
                        method: 'PATCH',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ data: { num_drinks: newCount } })
                    });

                    if (updateResponse.ok) {
                        const name = await getNameFromUid(uid);
                        const totalSpent = newCount * DRINK_COST;
                        if (name) {
                            showPopup(`Cheers, ${name}! ðŸ»\nYou've just bought your ${newCount}${getOrdinalSuffix(newCount)} drink!\nTotal spent: Â£${totalSpent}`);
                        } else {
                            showPopup(`Cheers! ðŸ»\nYou've just bought your ${newCount}${getOrdinalSuffix(newCount)} drink!\nTotal spent: Â£${totalSpent}`);
                        }
                        return newCount;
                    } else {
                        throw new Error(`Error updating UID ${uid}`);
                    }
                } else {
                    const newEntry = { uid: uid, num_drinks: 1 };
                    const addResponse = await fetch(DRINKS_API_URL, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ data: newEntry })
                    });

                    if (addResponse.ok) {
                        const name = await getNameFromUid(uid);
                        if (name) {
                            showPopup(`Welcome, ${name}! ðŸŽ‰\nYou've just bought your first drink!\nTotal spent: Â£${DRINK_COST}`);
                        } else {
                            showPopup(`Welcome! ðŸŽ‰\nYou've just bought your first drink!\nTotal spent: Â£${DRINK_COST}`);
                        }
                        return 1;
                    } else {
                        throw new Error(`Error adding UID ${uid}`);
                    }
                }
            } catch (error) {
                showPopup(`Error: ${error.message}`, 'error');
                return null;
            }
        }

        function getOrdinalSuffix(number) {
            const j = number % 10,
                  k = number % 100;
            if (j == 1 && k != 11) {
                return "st";
            }
            if (j == 2 && k != 12) {
                return "nd";
            }
            if (j == 3 && k != 13) {
                return "rd";
            }
            return "th";
        }

        async function handleNfcReading(uid) {
            const waitingPopup = showPopup("Please wait...");
            
            try {
                await scanSound.play();
                
                const totalDrinks = await incrementOrAddUid(uid);
                
                if (totalDrinks !== null) {
                    await uploadSound.play();
                }
            } catch (error) {
                showPopup(`Error: ${error.message}`, 'error');
            } finally {
                removePopup(waitingPopup);
            }
        }

        async function startReading() {
            if ('NDEFReader' in window) {
                try {
                    ndef = new NDEFReader();
                    updateStatus('Ready to scan! Place your tag on the back of the phone to buy a drink.');
                    
                    await ndef.scan();
                    
                    ndef.addEventListener("reading", ({ serialNumber }) => {
                        handleNfcReading(serialNumber);
                    });

                } catch (error) {
                    showPopup(`Error starting NFC: ${error.message}`, 'error');
                    updateStatus(`Error: ${error.message}`);
                }
            } else {
                showPopup('NFC not supported on this device', 'error');
                updateStatus('NFC not supported');
            }
        }

        // Start reading NFC tags automatically when the page loads
        window.addEventListener('load', startReading);

        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => console.log('ServiceWorker registration successful with scope: ', registration.scope))
                .catch(err => showPopup(`ServiceWorker registration failed: ${err.message}`, 'error'));
        }
    </script>
</body>
</html>